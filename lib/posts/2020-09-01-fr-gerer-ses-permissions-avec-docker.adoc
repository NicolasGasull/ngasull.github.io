= G√©rer ses permissions avec Docker
:categories: devops

Tout d'abord soyons d'accord sur les mots :

- L'*_h√¥te_* est le syst√®me d'exploitation de la machine, celui qui fait tourner Docker lui-m√™me
- Nous utiliserons *_conteneur_* pour se r√©f√©rer √† ce qui est ex√©cut√© dans l'univers de Docker
- Les *_user namespaces_*, que j'appellerai *_subuids_*, sont une fonctionnalit√© native Unix pour faire correspondre les ids d'utilisateurs syst√®me vers une page d'utilisateurs donn√©e.

L'article d√©crit comment utiliser les user namespaces (_subuids_) dans un environnement Unix pour r√©server une plage d'utilisateurs au daemon Docker. Il est probable que Docker for Mac supporte cette fonctionnalit√©.

== Motivation

Sur l'h√¥te, sans configuration donn√©e, les fichiers manipul√©s par Docker appartiennent au m√™me utilisateur que celui du conteneur. Ce n'est pas rassurant dans le sens o√π le daemon Docker tourne en `root` par d√©faut et que les conteneurs ne sont pas tenus de s'ex√©cuter en tant que l'utilisateur qui leur a √©t√© donn√© en configuration.

.Exemple :
[example]
Les images `postgres` et `mysql` √©crivent d'elles-m√™mes une partie de leurs fichiers avec les les utilisateurs de PostgreSQL et MySQL.

Pour √©viter ce probl√®me, nous allons indiquer au daemon Docker √† quels utilisateurs h√¥te correspondent tous les utilisateurs des conteneurs.

== Mise en place

[discrete]
===== Configuration h√¥te impact√©e :

- `/etc/subuid` - configuration des mappings utilisateur h√¥te <==> conteneur
- `/etc/subgid` - configuration des mappings groupe h√¥te <==> conteneur
- `/etc/docker/daemon.json` - configuration du daemon Docker

Selon moi, c'est avantageux de configurer diff√©remment ces mappings sur les machines des d√©veloppeurs et en CI/production. En effet : autant tirer profit de cette flexibilit√© pour d√©velopper confortablement tout en gardant la production sous contr√¥le.

=== Mappings de dev

En mappant le `root` des conteneurs vers ton utilisateur h√¥te, tu peux simplement profiter d'une transparence de permissions par d√©faut. Plus de probl√®mes avec les volumes g√©n√©r√©s en `root` h√¥te puis crashant l'ex√©cution √† cause de la mauvaise permission !

Pour ma part, je map simplement `root` vers mon user h√¥te puis tous les autres uids 1+ vers 100001+ sur l'h√¥te.

La seule chose √† confirmer : l'id de ton utilisateur h√¥te. C'est souvent 1000 et c'est v√©rifiable en ex√©cutant `id -u`.

[discrete]
===== /etc/subuid

```
dockremap:1000:1
dockremap:100001:65536
```

[discrete]
===== Explication

Un mapping nomm√© `dockremap` est cr√©√© :

- _1e ligne :_ assigne 1 utilisateur (de conteneur pour nous) vers l'uid 1000. Ce 1e utilisateur est l'utilisateur 0, donc `root`.
- _2e ligne :_ assigne les 65536 prochains utilisateurs vers la plage commen√ßant par 100001, donc vers 100001-165536. Par exemple, l'utilisateur conteneur 66 sera manipul√© sur l'h√¥te comme √©tant l'utilisateur 100066.

Je pense qu'appliquer le m√™me principe pour les groupes est tout aussi profitable : la transparence est totale. On peut v√©rifier son `gid` avec `id -g`.

[discrete]
===== /etc/subgid

```
dockremap:1000:1
dockremap:100001:65536
```

[discrete]
===== /etc/docker/daemon.json

```json
{
  "userns-remap": "dockremap"
}
```

N'oublie pas de red√©marrer le daemon docker pour que cela prenne effet üòâ

```bash
sudo service docker restart
```

=== Mappings de CI/production

En production, la configuration d√©pend davantage des permissions que tu veux donner √† tes conteneurs. On est davantage sur des probl√©matiques de s√©curit√© que de praticit√©.

Il est possible d'appliquer le m√™me type de configuration que pr√©c√©demment √† condition de bien conna√Ætre les cons√©quences du mapping, en particulier pour l'utilisateur 0.

== Probl√®mes et trucs √† savoir

Il est possible de mapper plusieurs utilisateurs sp√©cifiques conteneur vers des utilisateurs sp√©cifiques h√¥te. Par exemple :

```
dockremap:1000:1
dockremap:100001:65
dockremap:666:1
dockremap:100067:65469
```

Ce qui peut se lire : map 0 conteneur vers 1000 h√¥te, map les 65 utilisateurs suivants sur la plage h√¥te commen√ßant par 100001, map le suivant (66) vers 666 sur l'h√¥te, map le reste sur la plage h√¥te commen√ßant par 100067.

---

J'esp√®re que cet article t'aura √©clair√© sur l'utilisation des _user namespaces_ pour g√©rer ses permissions Docker. Il s'agit d'un retour d'exp√©rience personnelle et de mes avis sur le sujet. N'h√©site pas √† explorer par toi-m√™me, faire ta propre configuration et link:/fr/about/[me la partager] üôÇ
